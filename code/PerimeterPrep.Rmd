---
title: "Fire Perimeter Preparation"
author: "Zack Steel"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = "..")
library(tidyverse)
library(sf)
library(knitr)
library(mapview)
```

This document gives an example of how to prepare fire perimeters to be used in [Google Earth Engine](https://tinyurl.com/CBImodel) with the [Parks et al. 2019](https://www.mdpi.com/2072-4292/11/14/1735) model to estimate fire severity. I will use California's [FRAP](https://frap.fire.ca.gov/mapping/gis-data/) interagency fire perimeter database which includes fires down to 10 acres in size (4 ha) back to 1950. I'll focus on just the Headwaters of the Merced River watershed of Yosemite.  


```{r}
## Read in some perimeters - pre-filtered somewhat
pers <- read_sf("data/spatial/firep.shp") %>% 
  mutate(Fire_Year = as.integer(YEAR_)) %>% 
  dplyr::select(FIRE_NAME, FIRE_NUM, Fire_Year, ALARM_DATE, CONT_DATE)

## Get Merced HUC10
huc <- read_sf("data/spatial/yose_sheds.shp") %>% 
  filter(Name == "Headwaters Merced River") %>% 
  ## match coordinate system
  st_transform(crs = st_crs(pers)) %>% 
  dplyr::select(Name)

## Limit extent and to fires after 1984
keep <- st_intersects(pers, huc) %>% 
  apply(1, any)
pers1 <- pers[keep,]

## take a look
mapview(huc, col.regions = "darkgreen") + mapview(pers1)
```

Make the perimaters match what the Park's model expects.  

```{r}
## Make names match Parks model
out <- mutate(pers1,
              state = "CA")
## Region-specific cut-offs see Parks et al. 2019
dates <- data.frame(
  state = c("AZ", "CA", "CO", "ID", "KS", "MT", "ND", "NE", "NM", "NV", 
            "OK", "OR", "SD", "TX", "UT", "WA", "WY"),
  Start_Day = as.integer(c(91, 152, 152, 152, 121, 152, 152, 121, 91, 91,
                121, 152, 152, 121, 152, 152, 152)),
  End_Day = as.integer(c(181, 258, 258, 258, 212, 258, 258, 212, 181, 181,
              212, 218, 218, 212, 218, 218, 218)))
out2 <- merge(out, dates, by = "state") %>% 
  mutate(ID = 1:n()) %>% 
  dplyr::select(ID, Fire_Name = FIRE_NAME, Fire_ID = FIRE_NUM, Fire_Year, Start_Day = ALARM_DATE, End_Day = CONT_DATE)

st_write(out2, "data/spatial/gee_pers.shp")
```


